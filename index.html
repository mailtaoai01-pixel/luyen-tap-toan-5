<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>To√°n 5 ‚Äî Luy·ªán theo tu·∫ßn (Tr·ª£ l√Ω AI)</title>
<style>
    :root{
  --bg1: #e3f2fd;         /* xanh nh·∫°t */
  --bg2: #bbdefb;         /* xanh lam nh·∫°t */
  --card: #ffffffcc;       /* tr·∫Øng trong su·ªët nh·∫π */
  --accent: #0288d1;       /* xanh lam ƒë·∫≠m */
  --muted: #455a64;        /* x√°m ch·ªØ ph·ª• */
  --glass: rgba(255,255,255,0.6);
  }
  html,body {
  height:100%;
  margin:0;
  font-family: "Inter", "Segoe UI", Roboto, Arial;
  background:
    radial-gradient(circle at 10% 20%, var(--bg1), var(--bg2) 80%),
    url('https://www.transparenttextures.com/patterns/pw-maze-white.png'); /* h·ªça ti·∫øt nh·∫π */
  color:#0d1b2a;
  background-attachment: fixed;
  background-size: cover;
}

/* Gi·ªØ c√°c card n·ªïi b·∫≠t h∆°n tr√™n n·ªÅn s√°ng */
.card {
  background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.8));
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  color: #0d1b2a;
}

/* C·∫≠p nh·∫≠t m√†u n√∫t ch√≠nh */
button.primary {
  background: linear-gradient(90deg, var(--accent), #42a5f5);
  color: #fff;
  font-weight:600;
  border:none;
  box-shadow: 0 2px 6px rgba(2,136,209,0.4);
}

button.primary:hover {
  filter: brightness(1.1);
}

/* C√¢u h·ªèi v√† l·ª±a ch·ªçn n·ªïi r√µ tr√™n n·ªÅn s√°ng */
.question {
  background: #f5f9ff;
  border: 1px solid rgba(0,0,0,0.05);
}
.choice {
  background: #fff;
  color: #333;
  border: 1px solid rgba(0,0,0,0.05);
}
.choice.selected {outline: 2px solid rgba(2,136,209,0.3);}
.correct {background-color:#4CAF50!important; color:#fff;}
.incorrect {background-color:#f44336!important; color:#fff;}
  .container{max-width:1200px; margin:28px auto; padding:20px; display:grid; grid-template-columns: 1fr 360px; gap:20px;}
  header{grid-column:1/3; display:flex; justify-content:space-between; align-items:center; gap:16px;}
  h1{margin:0; font-size:20px; letter-spacing:0.2px;}
  .sub{color:var(--muted); font-size:13px;}

  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:18px; border-radius:12px; box-shadow: 0 6px 20px rgba(2,6,23,0.6);}
  .controls{display:flex; gap:12px; align-items:center; margin-bottom:12px;}
  select, button, input[type="number"]{background:var(--glass); color:var(--muted); border:1px solid rgba(255,255,255,0.03); padding:10px 12px; border-radius:8px; font-size:14px;}
  button.primary{background:linear-gradient(90deg,var(--accent), #3b82f6); color:#012; font-weight:600; border:none;}
  .question-list{margin-top:12px; display:flex; flex-direction:column; gap:12px; max-height:58vh; overflow:auto;}
  .question{background:rgba(255,255,255,0.02); padding:12px; border-radius:10px; display:flex; gap:12px; align-items:flex-start;}
  .q-left{min-width:44px; background:#071833; color:var(--accent); border-radius:8px; padding:8px 10px; font-weight:700;}
  .q-body{flex:1;}
  .choices{display:flex; flex-direction:column; gap:8px; margin-top:8px;}
  .choice{background:#071026; padding:8px; border-radius:8px; cursor:pointer; border:1px solid transparent; color:#e6eef6;}
  .choice:hover{border-color:rgba(255,255,255,0.04);}
  .choice.selected{outline:2px solid rgba(6,182,212,0.12);}

  .footer-actions{display:flex; justify-content:space-between; align-items:center; margin-top:14px;}
  .score{font-weight:700; color:var(--accent);}

  .assistant-panel{display:flex; flex-direction:column; gap:12px; height:calc(100vh - 120px); position:sticky; top:24px;}
  .assistant-card{display:flex; gap:12px; align-items:center; padding:12px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));}
  .avatar {
  display:flex;
  align-items:center;
  justify-content:center;
  background:none;
  box-shadow:none;
  position:relative;
  overflow:visible;
}
  .avatar .face{width:56px; height:56px; border-radius:12px; background:rgba(255,255,255,0.12); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:20px; transform-origin:center;}
  .avatar{animation:float 3.6s ease-in-out infinite;}
  @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}

  .assistant-meta{flex:1;}
  .assistant-meta .name{font-size:16px; font-weight:700;}
  .assistant-meta .desc{font-size:13px; color:var(--muted);}

  .chat{flex:1; display:flex; flex-direction:column; gap:8px; overflow:hidden;}
  .chat-window{flex:1; overflow:auto; padding:12px; border-radius:10px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03));}
  .msg{margin-bottom:10px; display:flex; gap:8px;}
  .msg.user{justify-content:flex-end;}
  .bubble{max-width:78%; padding:8px 12px; border-radius:12px; background:#052033; color:#dff7ff; font-size:14px;}
  .bubble.user{background:#074b59; color:#cfeeea;}
  .chat-input{display:flex; gap:8px; margin-top:6px;}
  textarea.chat-text{flex:1; min-height:54px; border-radius:10px; padding:10px; background:transparent; border:1px solid rgba(255,255,255,0.04); color:inherit;}
  .small{font-size:12px; color:var(--muted);}

  @media (max-width:1024px){ .container{grid-template-columns:1fr; padding:12px;} .assistant-panel{position:relative; height:auto;} }
  .option-btn {
    display: block;
    width: 100%;
    text-align: left;
    border: 2px solid transparent;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 6px;
    background-color: #222;
    color: #fff;
    transition: all 0.2s;
    cursor: pointer;
  }

  .option-btn:hover {
    background-color: #333;
  }
/* ==== S·ªë th·ª© t·ª± c√¢u h·ªèi: n·ªÅn v√†ng nh·∫°t, s·ªë ƒë·ªè ==== */
.q-left {
  min-width: 44px;
  background: #fff8e1;        /* v√†ng nh·∫°t d·ªãu m·∫Øt */
  color: #d32f2f;             /* ƒë·ªè t∆∞∆°i */
  border-radius: 8px;
  padding: 8px 10px;
  font-weight: 700;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  border: 1px solid rgba(0,0,0,0.05);
}

/* ==== L√†m s√°ng c√°c ƒë√°p √°n l·ª±a ch·ªçn ==== */
.choice {
  background: #f0f0f0;         /* x√°m nh·∫°t */
  color: #222;                 /* ch·ªØ ƒë·∫≠m */
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 10px;
  cursor: pointer;
  transition: all 0.2s ease;
}

/* Khi r√™ chu·ªôt v√†o ƒë√°p √°n */
.choice:hover {
  background: #e0e0e0;
  border-color: #bbb;
}

/* Khi h·ªçc sinh ch·ªçn */
.choice.selected {
  outline: 2px solid rgba(2,136,209,0.4);
  background: #e3f2fd;
  color: #01579b;
}

/* Khi ƒë√∫ng ‚Äì sai */
.choice.correct {
  background-color: #4CAF50 !important;
  color: #fff;
}
.choice.incorrect {
  background-color: #f44336 !important;
  color: #fff;
}

  /* Khi h·ªçc sinh ch·ªçn */
  .selected {
    background-color: #ffcc00 !important; /* v√†ng s√°ng */
    color: #000;
    border-color: #ffeb3b;
    box-shadow: 0 0 10px 2px rgba(255, 235, 59, 0.7);
  }

  /* ƒê√°p √°n ƒë√∫ng */
  .correct {
    background-color: #4CAF50 !important; /* xanh */
    color: #fff;
  }

  /* ƒê√°p √°n sai */
  .incorrect {
    background-color: #f44336 !important; /* ƒë·ªè */
    color: #fff;
  }
  /* ===== HI·ªÜU ·ª®NG N·ªÄN ƒê·ªòNG NH·∫∏ ===== */
html, body {
  background: linear-gradient(120deg, #e3f2fd, #bbdefb, #e3f2fd);
  background-size: 400% 400%;
  animation: gradientMove 15s ease infinite;
}
@keyframes gradientMove {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* ===== CARD N·ªîI NH·∫∏ ===== */
.card {
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 18px rgba(0,0,0,0.15);
}

/* ===== N√öT ƒê·ªòNG ===== */
button.primary {
  transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.3s ease;
}
button.primary:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(2,136,209,0.4);
  filter: brightness(1.1);
}

/* ===== S·ªê C√ÇU H·ªéI RUNG NH·∫∏ ===== */
.q-left {
  animation: float 3s ease-in-out infinite;
}
@keyframes float {
  0% { transform: translateY(0); }
  50% { transform: translateY(-4px); }
  100% { transform: translateY(0); }
}
/* === N√∫t chatbox (b·∫£n n√¢ng cao) === */
#sendChat {
  background: linear-gradient(90deg, #06b6d4, #3b82f6);
  color: #012;
  font-weight: 700;
  font-size: 16px;
  border: none;
  border-radius: 10px;
  padding: 10px;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
  transition: all 0.25s ease;
}
#sendChat:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 12px rgba(59, 130, 246, 0.4);
}

/* Hai n√∫t voice v√† clear */
#voiceBtn, #clearChat {
  font-weight: 600;
  border-radius: 8px;
  padding: 8px 10px;
  transition: all 0.25s ease;
  border: 1px solid rgba(255,255,255,0.1);
}

/* üé§ Voice button - b√¨nh th∆∞·ªùng v√† khi b·∫•m */
#voiceBtn {
  background: rgba(255, 255, 255, 0.15);
  color: #fff9c4; /* v√†ng nh·∫°t nh·∫π */
}
#voiceBtn:hover {
  background: rgba(255, 255, 200, 0.25);
  color: #fff;
}
/* Khi ƒëang ghi √¢m (active) ‚Üí v√†ng n·ªïi */
#voiceBtn.active {
  background: #ffeb3b;
  color: #333;
  box-shadow: 0 0 10px 2px rgba(255, 235, 59, 0.6);
}

/* üóë Clear button - s√°ng h∆°n */
#clearChat {
  background: rgba(255,255,255,0.25);
  color: #f1f5f9;
}
#clearChat:hover {
  background: rgba(255,255,255,0.4);
  color: #fff;
}

/* Hi·ªáu ·ª©ng b·∫•m gi·ªØ */
#voiceBtn:active, #clearChat:active, #sendChat:active {
  transform: scale(0.96);
}
/* üé§ Voice button ‚Äì m√†u v√†ng nh·∫°t n·ªïi r√µ */
#voiceBtn {
  background: #fff8e1;        /* v√†ng nh·∫°t s√°ng h∆°n */
  color: #d17f00;             /* ch·ªØ v√†ng cam ƒë·∫≠m */
  border: 1px solid #fdd835;
  font-weight: 600;
  box-shadow: 0 2px 5px rgba(0,0,0,0.15);
}
#voiceBtn:hover {
  background: #ffecb3;
  color: #a15f00;
}

/* Khi ƒëang ghi √¢m (active) ‚Üí v√†ng n·ªïi b·∫≠t h∆°n */
#voiceBtn.active {
  background: #ffeb3b;
  color: #333;
  box-shadow: 0 0 10px 2px rgba(255, 235, 59, 0.6);
}

/* üóë Clear button ‚Äì m√†u x√°m nh·∫°t */
#clearChat {
  background: #eceff1;        /* x√°m nh·∫°t r√µ r√†ng */
  color: #37474f;             /* ch·ªØ x√°m ƒë·∫≠m */
  border: 1px solid #cfd8dc;
  font-weight: 600;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
#clearChat:hover {
  background: #cfd8dc;
  color: #000;
}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>To√°n 5 ‚Äî Luy·ªán t·∫≠p theo tu·∫ßn (B·ªô s√°ch Ch√¢n Tr·ªùi S√°ng T·∫°o)</h1>
        <div class="sub">·ª®ng d·ª•ng AI t·∫°o b√†i t·∫≠p & tr·ª£ gi√∫p h·ªçc sinh</div>
      </div>
      <div class="small">Gi√°o vi√™n: Ph·∫°m Th√°i Sang <strong>  </strong> &nbsp; ‚Ä¢ &nbsp; L·ªõp 5</div>
    </header>

    <main class="card">
      <div class="controls">
        <label for="week">Ch·ªçn tu·∫ßn:</label>
        <select id="week">
          <option value="1">Tu·∫ßn 1</option>
          <option value="2">Tu·∫ßn 2</option>
          <option value="3">Tu·∫ßn 3</option>
          <option value="4">Tu·∫ßn 4</option>
          <option value="5">Tu·∫ßn 5</option>
		  <option value="5">Tu·∫ßn 6</option>
		  <option value="5">Tu·∫ßn 7</option>
		  <option value="5">Tu·∫ßn 8</option>
		  <option value="5">Tu·∫ßn 9</option>
		  <option value="5">Tu·∫ßn 10</option>
		  <option value="5">Tu·∫ßn 11</option>
		  <option value="5">Tu·∫ßn 12</option>
		  <option value="5">Tu·∫ßn 13</option>
		  <option value="5">Tu·∫ßn 14</option>
		  <option value="5">Tu·∫ßn 15</option>
		  <option value="5">Tu·∫ßn 16</option>
		  <option value="5">Tu·∫ßn 17</option>
		  <option value="5">Tu·∫ßn 18</option>
		  <option value="5">Tu·∫ßn 19</option>
		  <option value="5">Tu·∫ßn 20</option>
		  <option value="5">Tu·∫ßn 21</option>
		  <option value="5">Tu·∫ßn 22</option>
		  <option value="5">Tu·∫ßn 23</option>
		  <option value="5">Tu·∫ßn 24</option>
        </select>
        <button class="primary" id="genBtn">üéØ T·∫°o b√†i t·∫≠p tu·∫ßn</button>
        <button id="resetBtn" title="X√≥a k·∫øt qu·∫£ hi·ªán t·∫°i">‚ü≤ Reset</button>
      </div>

      <div id="info" class="small">Ch·ªçn tu·∫ßn v√† nh·∫•n "T·∫°o b√†i t·∫≠p tu·∫ßn" ƒë·ªÉ l√†m 10 c√¢u tr·∫Øc nghi·ªám</div>

      <div class="question-list" id="qList"></div>

      <div class="footer-actions">
        <div class="small">   </div>
        <div>
          <span class="score" id="scoreText">ƒêi·ªÉm: 0/0</span>
          <button id="checkBtn" class="primary">N·ªôp & Ch·∫•m</button>
        </div>
      </div>
    </main>
    <aside class="assistant-panel">
      <div class="assistant-card card">
        <div class="avatar" aria-hidden>
          <div class="ai-icon">
  <img src="avata.gif" alt="Tr·ª£ l√Ω AI To√°n 5" style="width:60px; height:110px ; border:none; border-radius:0; object-fit:contain;" style="object-fit:cover;">
</div>

        </div>
        <div class="assistant-meta">
          <div class="name">Tr·ª£ l√Ω To√°n 5</div>
          <div class="desc">B·∫°n ∆°i kh√¥ng hi·ªÉu, h·ªèi m√¨nh ngay nh√©!</div>
        </div>
      </div>

      <div class="card chat">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:700">Khung Chat v·ªõi Tr·ª£ l√Ω AI</div>
          <div class="small">K·∫øt n·ªëi: <span id="connState">online</span></div>
        </div>

        <div id="chatWindow" class="chat-window" aria-live="polite"></div>

      <div class="chat-input">
  <textarea id="chatText" class="chat-text" placeholder="H·ªçc sinh h·ªèi: 'L√†m sao ƒë·ªÉ t√¨m di·ªán t√≠ch h√¨nh ch·ªØ nh·∫≠t?'"></textarea>
  
  <div style="display:flex; flex-direction:column; gap:8px; align-items:stretch;">
    <!-- H√†ng 1: n√∫t G·ª¨I -->
    <button id="sendChat" class="primary" style="font-size:16px; padding:10px;">G·ª≠i üí¨</button>
    
    <!-- H√†ng 2: n√∫t Voice + X√≥a -->
    <div style="display:flex; gap:8px; justify-content:center;">
      <button id="voiceBtn" title="N√≥i ƒë·ªÉ nh·∫≠p" style="flex:1;">üé§ N√≥i</button>
      <button id="clearChat" title="X√≥a khung chat" style="flex:1;">üóë X√≥a</button>
    </div>
    
    <div class="small" id="voiceStatus"></div>
  </div>
</div>



<script>
/* --- Question bank: tu·∫ßn 1..5 (m·∫´u theo ch∆∞∆°ng tr√¨nh To√°n 5) --- */
const templates = {
  /* ===== TU·∫¶N 1: √în t·∫≠p s·ªë t·ª± nhi√™n v√† c√°c ph√©p t√≠nh ===== */
  week1: [
    { text: "Gi√° tr·ªã c·ªßa ch·ªØ s·ªë 5 trong s·ªë 45 382 l√†:", options:["5 ngh√¨n","5 trƒÉm","5 ch·ª•c","5 ƒë∆°n v·ªã"], correct: 0 },
    { text: "S√™u bi·ªÉu th·ª©c: 300 + 120 √ó 2 =", options:["540","840","420","760"], correct: 0 },
    { text: "S·ªë? ...... + 3 = 21", options:["18","24","17","19"], correct: 0 },
    { text: "S·ªë? ...... - 7 = 25", options:["32","27","18","30"], correct: 0 },
    { text: "S·ªë? ...... √ó 6 = 54", options:["9","8","7","6"], correct: 0 },
    { text: "S·ªë? ...... √∑ 5 = 9", options:["45","14","25","15"], correct: 0 },
    { text: "T·ªïng 345 v√† 678 l√†:", options:["1023","1013","1033","1020"], correct: 0 },
    { text: "Hi·ªáu 902 v√† 478 l√†:", options:["424","434","452","412"], correct: 0 },
    { text: "K·∫øt qu·∫£ c·ªßa ph√©p t√≠nh 125 √ó 4 =", options:["500","425","450","400"], correct: 0 },
    { text: "S·ªë n√†o chia h·∫øt cho 9: 135, 144, 152?", options:["135","144","152","Kh√¥ng c√≥"], correct: 0 },
    { text: "S·ªë? ...... + 48 = 100", options:["52","58","60","50"], correct: 0 },
    { text: "S·ªë? ...... √ó 7 = 56", options:["8","9","7","6"], correct: 0 },
    { text: "S·ªë tr√≤n ch·ª•c g·∫ßn nh·∫•t c·ªßa 467 l√†:", options:["470","460","400","500"], correct: 0 },
    { text: "S·∫Øp x·∫øp tƒÉng d·∫ßn: 408, 480, 804, 840", options:["408, 480, 804, 840","408, 804, 480, 840","804, 840, 408, 480","480, 408, 840, 804"], correct: 0 },
    { text: "K·∫øt qu·∫£ 4200 + 80 + 3 l√†:", options:["4283","4238","4823","4382"], correct: 0 },
    { text: "M·ªôt th√πng c√≥ 125 qu·∫£ cam, 4 th√πng c√≥:", options:["500 qu·∫£","400 qu·∫£","450 qu·∫£","550 qu·∫£"], correct: 0 },
    { text: "S·ªë? ...... √ó 8 = 64", options:["8","7","6","9"], correct: 0 },
    { text: "S·ªë? ...... - 25 = 75", options:["100","90","80","95"], correct: 0 },
    { text: "T·ªïng c√°c ch·ªØ s·ªë c·ªßa 3456 l√†:", options:["18","16","17","15"], correct: 0 },
    { text: "Trong c√°c s·ªë 34 509; 34 950; 34 905; s·ªë l·ªõn nh·∫•t l√†:", options:["34 950","34 905","34 509","34 590"], correct: 0 }
  ],

  /* ===== TU·∫¶N 2: √în t·∫≠p v√† b·ªï sung v·ªÅ ph√¢n s·ªë ===== */
  week2: [
    { text: "Ph√¢n s·ªë n√†o b·∫±ng 1/2?", options:["2/4","3/4","1/3","4/6"], correct: 0 },
    { text: "R√∫t g·ªçn ph√¢n s·ªë 6/8 ta ƒë∆∞·ª£c:", options:["3/4","6/8","2/3","4/3"], correct: 0 },
    { text: "Ph√¢n s·ªë 4/5 c√≥ t·ª≠ s·ªë l√†:", options:["4","5","9","1"], correct: 0 },
    { text: "Ph√¢n s·ªë 4/5 c√≥ m·∫´u s·ªë l√†:", options:["5","4","9","1"], correct: 0 },
    { text: "Ph√¢n s·ªë l·ªõn h∆°n 3/5 l√†:", options:["4/5","2/5","1/5","3/6"], correct: 0 },
    { text: "Ph√¢n s·ªë 10/15 r√∫t g·ªçn ƒë∆∞·ª£c:", options:["2/3","3/2","5/3","3/5"], correct: 0 },
    { text: "Ph√¢n s·ªë n√†o b·∫±ng 0,5?", options:["1/2","2/3","3/4","1/4"], correct: 0 },
    { text: "Ph√¢n s·ªë n√†o nh·ªè nh·∫•t: 1/3, 1/4, 1/2?", options:["1/4","1/3","1/2","3/4"], correct: 0 },
    { text: "T·ªïng 1/4 + 1/4 =", options:["1/2","1/4","2/4","3/4"], correct: 0 },
    { text: "Hi·ªáu 3/4 - 1/4 =", options:["1/2","2/4","3/4","1/4"], correct: 0 },
    { text: "Ph√¢n s·ªë n√†o b·∫±ng 6/9?", options:["2/3","1/3","3/2","3/4"], correct: 0 },
    { text: "Ph√¢n s·ªë t·ªëi gi·∫£n c·ªßa 8/12 l√†:", options:["2/3","3/2","4/6","1/3"], correct: 0 },
    { text: "So s√°nh 2/5 v√† 3/5:", options:["2/5 < 3/5","2/5 = 3/5","2/5 > 3/5","Kh√¥ng so s√°nh ƒë∆∞·ª£c"], correct: 0 },
    { text: "Ph√¢n s·ªë 5/10 v√† 1/2 l√†:", options:["B·∫±ng nhau","5/10 l·ªõn h∆°n","1/2 l·ªõn h∆°n","Kh√¥ng so s√°nh ƒë∆∞·ª£c"], correct: 0 },
    { text: "S·ªë? ...... /3 = 2/3", options:["2","3","4","1"], correct: 0 },
    { text: "Ph√¢n s·ªë n√†o l·ªõn h∆°n 1?", options:["5/4","3/4","4/5","1/2"], correct: 0 },
    { text: "T·ªïng 1/3 + 1/6 =", options:["1/2","2/3","1/6","1/4"], correct: 0 },
    { text: "Hi·ªáu 5/6 - 1/3 =", options:["1/2","2/3","3/6","4/6"], correct: 0 },
    { text: "Ph√¢n s·ªë c√≥ t·ª≠ nh·ªè h∆°n m·∫´u l√†:", options:["3/4","4/3","5/4","2/1"], correct: 0 },
    { text: "Ph√¢n s·ªë n√†o b·∫±ng 0,25?", options:["1/4","2/5","3/8","1/2"], correct: 0 }
  ],

  /* ===== TU·∫¶N 3: T·ªâ s·ªë v√† b√†i to√°n r√∫t v·ªÅ ƒë∆°n v·ªã ===== */
  week3: [
    { text: "Mu·ªën t√¨m gi√° tr·ªã 1 ph·∫ßn, ta l√†m th·∫ø n√†o?", options:["Chia t·ªïng cho s·ªë ph·∫ßn","Nh√¢n t·ªïng v·ªõi s·ªë ph·∫ßn","C·ªông c√°c ph·∫ßn","Tr·ª´ c√°c ph·∫ßn"], correct: 0 },
    { text: "S·ªë? ...... ph·∫ßn b·∫±ng 20, v·∫≠y 1 ph·∫ßn b·∫±ng:", options:["4","5","10","6"], correct: 0 },
    { text: "N·∫øu 1 ph·∫ßn l√† 6, 4 ph·∫ßn l√†:", options:["24","12","30","18"], correct: 0 },
    { text: "T·ªâ s·ªë c·ªßa 3 v√† 6 l√†:", options:["1/2","2/3","1/3","3/6"], correct: 0 },
    { text: "T·ªâ s·ªë c·ªßa 8 v√† 4 l√†:", options:["2","1/2","1","3"], correct: 0 },
    { text: "M·ªôt l·ªõp c√≥ 12 b·∫°n nam v√† 8 b·∫°n n·ªØ. T·ªâ s·ªë nam/n·ªØ l√†:", options:["3/2","2/3","4/3","1/2"], correct: 0 },
    { text: "T·ªïng 25, t·ªâ s·ªë 2:3. S·ªë b√© l√†:", options:["10","12","15","8"], correct: 0 },
    { text: "S·ªë? ...... : 5 = 3", options:["15","8","10","5"], correct: 0 },
    { text: "Gi√° tr·ªã 1 ph·∫ßn khi 8 ph·∫ßn b·∫±ng 64 l√†:", options:["8","6","4","12"], correct: 0 },
    { text: "N·∫øu t·ªïng l√† 24 v√† t·ªâ s·ªë 2:1 th√¨ s·ªë l·ªõn l√†:", options:["16","8","12","14"], correct: 0 },
    { text: "S·ªë? ...... √ó 4 = 68", options:["17","16","18","15"], correct: 0 },
    { text: "T·ªïng 2 s·ªë c√≥ t·ªâ s·ªë 2:3 v√† t·ªïng 25, s·ªë b√© l√†:", options:["10","12","15","8"], correct: 0 },
    { text: "T·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa 25 v√† 100 l√†:", options:["25%","50%","75%","20%"], correct: 0 },
    { text: "S·ªë? ...... √ó 9 = 81", options:["9","8","10","7"], correct: 0 },
    { text: "S·ªë? ...... + 8 = 19", options:["11","9","10","12"], correct: 0 },
    { text: "N·∫øu a : b = 3 : 1 th√¨ a g·∫•p b bao nhi√™u l·∫ßn?", options:["3 l·∫ßn","2 l·∫ßn","4 l·∫ßn","1/3 l·∫ßn"], correct: 0 },
    { text: "S·ªë? ...... : 2 = 12", options:["24","22","26","20"], correct: 0 },
    { text: "N·∫øu 4 ph·∫ßn = 32, 7 ph·∫ßn b·∫±ng:", options:["56","49","63","48"], correct: 0 },
    { text: "S·ªë? ...... + 25 = 70", options:["45","55","65","35"], correct: 0 },
    { text: "T·ªâ s·ªë 1:4 vi·∫øt d∆∞·ªõi d·∫°ng ph√¢n s·ªë l√†:", options:["1/4","4/1","4/5","3/4"], correct: 0 }
  ],

  /* ===== TU·∫¶N 4: T√¨m hai s·ªë khi bi·∫øt t·ªïng, hi·ªáu, t·ªâ s·ªë ===== */
  week4: [
    { text: "T·ªïng 60, t·ªâ s·ªë 2:3. S·ªë l·ªõn l√†:", options:["36","24","30","20"], correct: 0 },
    { text: "T·ªïng 45, t·ªâ s·ªë 1:2. S·ªë b√© l√†:", options:["15","30","20","25"], correct: 0 },
    { text: "Hi·ªáu 15, t·ªâ s·ªë 2:3. S·ªë l·ªõn l√†:", options:["45","30","25","35"], correct: 0 },
    { text: "Hi·ªáu 20, t·ªâ s·ªë 2:5. S·ªë b√© l√†:", options:["20","30","40","50"], correct: 0 },
    { text: "Hai s·ªë c√≥ t·ªïng 80, t·ªâ s·ªë 3:5. S·ªë b√© l√†:", options:["30","50","48","32"], correct: 0 },
    { text: "T·ªïng 72, t·ªâ s·ªë 1:3. S·ªë l·ªõn l√†:", options:["54","36","24","48"], correct: 0 },
    { text: "S·ªë? ...... + 15 = 42", options:["27","25","28","30"], correct: 0 },
    { text: "S·ªë? ...... - 16 = 48", options:["64","60","68","62"], correct: 0 },
    { text: "T·ªïng 90, t·ªâ s·ªë 2:1. S·ªë l·ªõn l√†:", options:["60","45","50","30"], correct: 0 },
    { text: "T·ªïng 120, t·ªâ s·ªë 3:5. S·ªë b√© l√†:", options:["45","72","48","60"], correct: 0 },
    { text: "Hi·ªáu 18, t·ªâ s·ªë 2:5. S·ªë b√© l√†:", options:["12","20","18","22"], correct: 0 },
    { text: "S·ªë? ...... √ó 6 = 54", options:["9","8","7","6"], correct: 0 },
    { text: "S·ªë? ...... √∑ 4 = 9", options:["36","32","28","40"], correct: 0 },
    { text: "T·ªïng 50, t·ªâ s·ªë 3:2. S·ªë l·ªõn l√†:", options:["30","20","25","15"], correct: 0 },
    { text: "S·ªë? ...... + 8 = 23", options:["15","14","16","13"], correct: 0 },
    { text: "T·ªïng 72, t·ªâ s·ªë 1:2. S·ªë l·ªõn l√†:", options:["48","36","24","40"], correct: 0 },
    { text: "Hi·ªáu 24, t·ªâ s·ªë 2:5. S·ªë l·ªõn l√†:", options:["60","48","40","30"], correct: 0 },
    { text: "S·ªë? ...... - 9 = 18", options:["27","28","26","25"], correct: 0 },
    { text: "T·ªïng 60, t·ªâ s·ªë 3:2. S·ªë b√© l√†:", options:["24","30","20","36"], correct: 0 },
    { text: "Hi·ªáu 18, t·ªâ s·ªë 4:7. S·ªë l·ªõn l√†:", options:["42","30","28","24"], correct: 0 }
  ],

  /* ===== TU·∫¶N 5: H√©c-ta ‚Äì Ki-l√¥-m√©t vu√¥ng ‚Äì T·ªâ l·ªá b·∫£n ƒë·ªì ===== */
  week5: [
    { text: "1 m¬≤ = bao nhi√™u cm¬≤?", options:["10 000","1 000","100","100 000"], correct: 0 },
    { text: "1 ha = bao nhi√™u m¬≤?", options:["10 000","1 000","100","100 000"], correct: 0 },
    { text: "1 km¬≤ = bao nhi√™u ha?", options:["100","10","1000","10000"], correct: 0 },
    { text: "10 000 m¬≤ = bao nhi√™u ha?", options:["1 ha","10 ha","0,1 ha","100 ha"], correct: 0 },
    { text: "Chi·ªÅu d√†i b·∫£n ƒë·ªì 5 cm, t·ªâ l·ªá 1 : 10 000. Chi·ªÅu d√†i th·∫≠t l√†:", options:["500 m","50 m","5 km","0,5 km"], correct: 0 },
    { text: "T·ªâ l·ªá 1 : 2000 nghƒ©a l√† 1 cm b·∫£n ƒë·ªì b·∫±ng:", options:["2000 cm ngo√†i th·ª±c t·∫ø","200 m","20 m","2 m"], correct: 0 },
    { text: "1 ha b·∫±ng bao nhi√™u a?", options:["100 a","10 a","1000 a","1 a"], correct: 0 },
    { text: "1 ha b·∫±ng bao nhi√™u m¬≤?", options:["100 m¬≤","10 m¬≤","1000 m¬≤","10 000 m¬≤"], correct: 0 },
    { text: "M·ªôt m·∫£nh ƒë·∫•t d√†i 60 m, r·ªông 40 m. Di·ªán t√≠ch l√†:", options:["2400 m¬≤","2000 m¬≤","2600 m¬≤","400 m¬≤"], correct: 0 },
    { text: "0,5 ha = ?", options:["5 000 m¬≤","50 m¬≤","500 m¬≤","5 m¬≤"], correct: 0 },
    { text: "T·ªâ l·ªá b·∫£n ƒë·ªì 1 : 5 000. 1 cm b·∫£n ƒë·ªì ·ª©ng v·ªõi:", options:["50 m","5 m","500 m","0,5 km"], correct: 0 },
    { text: "S·ªë? ...... √ó 10 000 = 30 000", options:["3","30","300","3000"], correct: 0 },
    { text: "ƒê·ªïi 2,5 ha ra m¬≤:", options:["25 000 m¬≤","250 000 m¬≤","2 500 m¬≤","2500 m¬≤"], correct: 0 },
    { text: "1 km¬≤ = bao nhi√™u m¬≤?", options:["1 000 000","100 000","10 000","1 000"], correct: 0 },
    { text: "M·ªôt khu r·ª´ng c√≥ di·ªán t√≠ch 4 ha = ?", options:["40 000 m¬≤","400 m¬≤","4 000 m¬≤","40000 cm¬≤"], correct: 0 },
    { text: "S·ªë? ...... √∑ 100 = 35", options:["3 500","350","3 000","300"], correct: 0 },
    { text: "T·ªâ l·ªá b·∫£n ƒë·ªì 1 : 100 000 nghƒ©a l√† 1 cm b·∫£n ƒë·ªì b·∫±ng:", options:["1 km","10 km","100 km","100 m"], correct: 0 },
    { text: "S·ªë? ...... + 3000 = 10 000", options:["7 000","8 000","6 000","9 000"], correct: 0 },
    { text: "M·ªôt th·ª≠a ru·ªông 50 m √ó 20 m = ? ha", options:["0,1 ha","1 ha","0,01 ha","0,2 ha"], correct: 0 }
]
};
/* ================
   UI: generate quiz
   ================ */
const qListEl = document.getElementById('qList');
const weekSel = document.getElementById('week');
const genBtn = document.getElementById('genBtn');
const checkBtn = document.getElementById('checkBtn');
const resetBtn = document.getElementById('resetBtn');
const scoreText = document.getElementById('scoreText');

let current = { questions: [], answers: [] };
let chatEnabled = false; // üö´ Chat b·ªã kh√≥a l√∫c ƒë·∫ßu
function generateWeek(week){
  const key = 'week' + week;
  let source = templates[key] || templates['week1'];

  // --- L·∫•y ng·∫´u nhi√™n 10 c√¢u trong danh s√°ch g·ªëc ---
  const shuffled = [...source].sort(() => Math.random() - 0.5);
  const selected = shuffled.slice(0, 10);

  // --- V·ªõi m·ªói c√¢u, tr·ªôn th·ª© t·ª± ƒë√°p √°n ---
  const qs = selected.map((q, idx) => {
    const arr = q.options.map((o,i)=>({o,i}));
    for (let i = arr.length -1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    const options = arr.map(x=>x.o);
    const correctIndex = arr.findIndex(x=>x.i === q.correct);
    return { id: idx+1, text: q.text, options, correct: correctIndex };
  });

  // --- C·∫≠p nh·∫≠t d·ªØ li·ªáu hi·ªán h√†nh ---
  current.questions = qs;
  current.answers = new Array(qs.length).fill(null);
  renderQuestions();
  updateScore(0, qs.length);

  // L∆∞u l·∫°i v√†o localStorage ƒë·ªÉ khi load l·∫°i v·∫´n c√≥ ƒë·ªÅ n√†y
  localStorage.setItem('currentQuiz', JSON.stringify({week, qs}));
}

function renderQuestions(){
  qListEl.innerHTML = '';
  current.questions.forEach((q, qi) => {
    const el = document.createElement('div'); el.className='question';
    el.innerHTML = `
      <div class="q-left">${q.id}</div>
      <div class="q-body">
        <div class="q-text">${q.text}</div>
        <div class="choices" id="choices-${qi}"></div>
      </div>
    `;
    qListEl.appendChild(el);
    const choicesEl = document.getElementById(`choices-${qi}`);
    q.options.forEach((opt, oi) => {
      const btn = document.createElement('div');
      btn.className='choice';
      btn.innerText = String.fromCharCode(65+oi) + '. ' + opt;
      btn.addEventListener('click', ()=> {
        document.querySelectorAll(`#choices-${qi} .choice`).forEach(c=>c.classList.remove('selected'));
        btn.classList.add('selected');
        current.answers[qi] = oi;
      });
      choicesEl.appendChild(btn);
    });
  });
}

/* ====================
   Scoring & persistence
   ==================== */
function updateScore(correct, total){
  scoreText.innerText = `ƒêi·ªÉm: ${correct}/${total}`;
}

function checkAnswers(){
  let correct = 0;
  current.questions.forEach((q, i) => {
    if (current.answers[i] === q.correct) correct++;
  });
  updateScore(correct, current.questions.length);
  const wk = weekSel.value;
  const history = JSON.parse(localStorage.getItem('history')||'{}');
  history['week'+wk] = { timestamp: Date.now(), score: correct, total: current.questions.length };
  localStorage.setItem('history', JSON.stringify(history));
  alert(`B·∫°n ƒë∆∞·ª£c ${correct}/${current.questions.length} c√¢u ƒë√∫ng.`);
}
function checkAnswers() {
  let correct = 0;

  current.questions.forEach((q, i) => {
    const userAns = current.answers[i];
    const choiceEls = document.querySelectorAll(`#choices-${i} .choice`);

    choiceEls.forEach((btn, oi) => {
      btn.classList.remove("correct", "incorrect");

      if (oi === q.correct) {
        // ƒê√°p √°n ƒë√∫ng ‚Üí xanh
        btn.classList.add("correct");
      } else if (oi === userAns) {
        // H·ªçc sinh ch·ªçn sai ‚Üí ƒë·ªè
        if (userAns !== q.correct) btn.classList.add("incorrect");
      }

      // Sau khi n·ªôp th√¨ kh√≥a c√°c l·ª±a ch·ªçn
      btn.style.pointerEvents = "none";
    });

    if (userAns === q.correct) correct++;
  });

  updateScore(correct, current.questions.length);
  alert(`B·∫°n ƒë∆∞·ª£c ${correct}/${current.questions.length} c√¢u ƒë√∫ng.`);
  chatEnabled = true; // ‚úÖ M·ªü kh√≥a chat sau khi h·ªçc sinh ƒë√£ ch·∫•m xong
  // ‚ú® Hi·ªán th√¥ng b√°o t·ª± ·∫©n sau 3 gi√¢y, kh√¥ng c·∫ßn b·∫•m OK
const msg = document.createElement('div');
msg.innerText = 'Gi·ªèi l·∫Øm! B√¢y gi·ªù em c√≥ th·ªÉ h·ªèi Tr·ª£ l√Ω AI ƒë·ªÉ hi·ªÉu th√™m nh√©!';
msg.style.position = 'fixed';
msg.style.bottom = '20px';
msg.style.right = '20px';
msg.style.background = '#4caf50';
msg.style.color = '#fff';
msg.style.padding = '12px 18px';
msg.style.borderRadius = '8px';
msg.style.fontWeight = '600';
msg.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
msg.style.zIndex = '9999';
document.body.appendChild(msg);
setTimeout(() => msg.remove(), 3000);
}

function resetAll(){
  if (!confirm('Reset to√†n b·ªô d·ªØ li·ªáu luy·ªán t·∫≠p trong tr√¨nh duy·ªát?')) return;
  localStorage.removeItem('currentQuiz');
  localStorage.removeItem('history');
  current = {questions:[], answers:[]};
  qListEl.innerHTML = '';
  updateScore(0,0);
chatEnabled = false;
}

/* ====================
   Load saved set (if any)
   ==================== */
window.addEventListener('load', ()=>{
  const saved = JSON.parse(localStorage.getItem('currentQuiz')||'null');
  if (saved && saved.qs){
    current.questions = saved.qs;
    current.answers = new Array(saved.qs.length).fill(null);
    renderQuestions();
    updateScore(0, saved.qs.length);
  }
});

/* ================
   Event listeners
   ================ */
genBtn.addEventListener('click', ()=>{
  const saved = JSON.parse(localStorage.getItem('currentQuiz')||'null');
  if (saved && saved.week === weekSel.value) {
    alert('B·ªô c√¢u h·ªèi tu·∫ßn n√†y ƒë√£ ƒë∆∞·ª£c t·∫°o. N·∫øu mu·ªën t·∫°o l·∫°i ng·∫´u nhi√™n, h√£y b·∫•m n√∫t Reset.');
    return;
  }
  generateWeek(weekSel.value);
});

checkBtn.addEventListener('click', checkAnswers);

resetBtn.addEventListener('click', ()=>{
  if (!confirm('T·∫°o l·∫°i b·ªô c√¢u h·ªèi ng·∫´u nhi√™n cho tu·∫ßn n√†y?')) return;
  localStorage.removeItem('currentQuiz');
  generateWeek(weekSel.value);
    chatEnabled = false; // üö´ Kh√≥a l·∫°i chatbox sau khi reset ƒë·ªÅ
});


/* ======================
   Chat integration (frontend)
   ====================== */
const API_ENDPOINT = 'https://toan5-chatbot-1.onrender.com/api/chat'; // ch·ªânh n·∫øu b·∫°n host kh√°c

const chatWindow = document.getElementById('chatWindow');
const chatText = document.getElementById('chatText');
const sendChat = document.getElementById('sendChat');
const clearChat = document.getElementById('clearChat');
const connState = document.getElementById('connState');

function appendMessage(text, who='assistant'){
  const msg = document.createElement('div');
  msg.className = 'msg ' + (who==='user' ? 'user' : 'assistant');
  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + (who==='user' ? 'user' : '');
  bubble.innerText = text;
  msg.appendChild(bubble);
  chatWindow.appendChild(msg);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

sendChat.addEventListener('click', async ()=>{
    const text = chatText.value.trim();
if (!chatEnabled) {
    alert('Em h√£y l√†m xong b√†i v√† b·∫•m "N·ªôp & Ch·∫•m" tr∆∞·ªõc khi h·ªèi Tr·ª£ l√Ω nh√©!');
    return;
  } 
 if (!text) return;
  appendMessage(text,'user');
  chatText.value = '';
  appendMessage('ƒêang tr·∫£ l·ªùi...','assistant');

  try {
    const resp = await fetch(API_ENDPOINT, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        message: text,
        context: current.questions.map(q => ({ id: q.id, text: q.text, options: q.options })),
        answers: current.answers
      })
    });
    if (!resp.ok) throw new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server chat.');
    const data = await resp.json();
    const bubbles = chatWindow.querySelectorAll('.msg.assistant .bubble');
    if (bubbles.length) bubbles[bubbles.length-1].innerText = data.reply || 'Xin l·ªói, t√¥i kh√¥ng hi·ªÉu.';
    connState.innerText = 'online';
  } catch(e) {
    const bubbles = chatWindow.querySelectorAll('.msg.assistant .bubble');
    if (bubbles.length) bubbles[bubbles.length-1].innerText = 'L·ªói k·∫øt n·ªëi: ' + e.message;
    connState.innerText = 'offline';
  }
});
/* ---------- Speech to Text (micro) ---------- */
const voiceBtn = document.getElementById('voiceBtn');
const voiceStatus = document.getElementById('voiceStatus');
let recognition = null;

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = 'vi-VN';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onstart = () => {
    voiceStatus.innerText = 'üéôÔ∏è ƒêang nghe...';
    voiceBtn.style.background = '#0288d1';
    voiceBtn.style.color = '#fff';
  };
  recognition.onend = () => {
    voiceStatus.innerText = '';
    voiceBtn.style.background = '';
    voiceBtn.style.color = '';
  };
  recognition.onerror = (e) => {
    voiceStatus.innerText = 'L·ªói micro: ' + e.error;
  };

  recognition.onresult = (ev) => {
    const txt = ev.results[0][0].transcript;
    const chatTextEl = document.getElementById('chatText');
    chatTextEl.value = chatTextEl.value ? (chatTextEl.value + ' ' + txt) : txt;
    chatTextEl.focus();
  };
} else {
  voiceStatus.innerText = 'Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ voice input.';
  voiceBtn.disabled = true;
}

voiceBtn.addEventListener('click', () => {
  if (!recognition) return;
  try { recognition.start(); } catch(e) {}
});
/* ---------- N√∫t X√≥a chat & √¥ nh·∫≠p ---------- */
clearChat.addEventListener('click', ()=>{
  chatWindow.innerHTML = '';  // X√≥a khung h·ªôi tho·∫°i
  chatText.value = '';        // X√≥a n·ªôi dung ƒëang g√µ
  voiceStatus.innerText = ''; // X√≥a tr·∫°ng th√°i ghi √¢m n·∫øu c√≥
});
async function sendMessage() {
  const input = document.getElementById("chat-input");
  const message = input.value.trim();
  if (!message) return;
  
  appendMessage("B·∫°n", message);
  input.value = "";

  const response = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer sk-xxxxxxxxxxxxxxxx", // ‚ö†Ô∏è key th·∫≠t c·ªßa b·∫°n
    },
    body: JSON.stringify({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: "B·∫°n l√† tr·ª£ l√Ω ChatGPT To√°n 5." },
        { role: "user", content: message }
      ],
    }),
  });

  const data = await response.json();
  const reply = data.choices?.[0]?.message?.content || "Xin l·ªói, t√¥i ch∆∞a hi·ªÉu c√¢u h·ªèi.";
  appendMessage("ChatGPT", reply);
}
function selectOption(button, opt) {
  // X√≥a tr·∫°ng th√°i ch·ªçn c≈©
  document.querySelectorAll(".option-btn").forEach(b => b.classList.remove("selected"));
  // ƒê√°nh d·∫•u n√∫t ƒëang ch·ªçn
  button.classList.add("selected");
  selectedOption = opt;
}

submitBtn.addEventListener("click", () => {
  if (!selectedOption) return alert("H√£y ch·ªçn m·ªôt ƒë√°p √°n!");

  const buttons = document.querySelectorAll(".option-btn");
  buttons.forEach(btn => {
    const text = btn.textContent.slice(3); // b·ªè A./B./C./D.
    btn.disabled = true;
    if (text === currentQuestion.correct) {
      btn.classList.add("correct");
    } else if (text === selectedOption) {
      btn.classList.add("incorrect");
    }
  });

  explanationBox.innerHTML = `<strong>Gi·∫£i th√≠ch:</strong> ${currentQuestion.explanation}`;
  submitBtn.classList.add("hidden");
});

</script>
</body>
</html>
